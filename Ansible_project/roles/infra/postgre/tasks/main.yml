---

- name: install the packages
  include_role:
    name: os/package
  vars:
    package_action: "present"
    package_name: "{{ item }}"
    update_cache: yes
  loop:
    - postgresql
    - postgresql-contrib
    - postgresql-server-devel
    - python3-psycopg2
    - postgresql-server

#- name: create data cluster
#  command: service postgresql initdb

- name: Start and enable postgres
  service: name=postgresql enabled=yes state=started

- name: Create database
  postgresql_db: name={{ pg_django.db_name }}
  become_user: postgres
  become: yes

- name: Create user
  postgresql_user: db={{ pg_django.db_name }}
                   name={{ pg_django.user }}
                   password={{ pg_django.pass }}
                   priv=ALL
                   state=present
                   role_attr_flags=NOSUPERUSER,NOCREATEDB
  become: yes
  become_user: postgres

- name: Firewall role
  include_role:
    name: os/firewalld_2
  loop:
    - '5432/tcp'
  loop_control:
    loop_var: firewall_ports